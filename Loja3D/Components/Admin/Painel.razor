@page "/admin/painel"
@using Loja3D.Models
@using Loja3D.Data
@using Microsoft.EntityFrameworkCore
@inject LojaContext Contexto
@inject NavigationManager Navegador
@inject IJSRuntime JS // Injeta a capacidade de falar com o JavaScript

<PageTitle>Admin - Painel</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>🛠️ Gestão de Estoque</h1>
        <a href="admin/novo" class="btn btn-primary">
            + Novo Produto
        </a>
    </div>

    @if (produtos == null) {
        <p>Carregando...</p>
    }
    else if (!produtos.Any()) {
        <div class="alert alert-warning">Nenhum produto encontrado.</div>
    }
    else {
        <div class="table-responsive">
            <table class="table table-striped table-hover shadow-sm">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Imagem</th>
                        <th>Nome</th>
                        <th>Preço</th>
                        <th>Estoque</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in produtos) {
                        <tr>
                            <td>@p.Id</td>
                            <td>
                                <img src="@p.ImagemUrl" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" />
                            </td>
                            <td>@p.Nome</td>
                            <td>R$ @p.Preco.ToString("N2")</td>
                            <td>
                                <span class="badge @(p.Estoque < 5 ? "bg-danger" : "bg-success")">
                                    @p.Estoque un.
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeletarProduto(p)">
                                    🗑️ Excluir
                                </button>

                                <a href="admin/editar/@p.Id" class="btn btn-sm btn-warning">
                                    ✏️ Editar
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    List<Produto> produtos = new();

    protected override async Task OnInitializedAsync() {
        await CarregarProdutos();
    }

    private async Task CarregarProdutos() {
        produtos = await Contexto.Produtos.ToListAsync();
    }

    private async Task DeletarProduto(Produto produto) {
        // 1. Pergunta pro usuário se ele tem certeza (usando JavaScript)
        bool confirmacao = await JS.InvokeAsync<bool>("confirm", $"Tem certeza que quer apagar o {produto.Nome}?");

        if (confirmacao) {
            // 2. Remove do Banco
            Contexto.Produtos.Remove(produto);
            await Contexto.SaveChangesAsync();

            // 3. Atualiza a lista na tela para sumir o item deletado
            await CarregarProdutos();
        }
    }
}